<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorpiora Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a311e 0%, #2d4b32 100%);
        }
        
        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #4a9e5b;
        }
        
        .login-form .form-group {
            margin-bottom: 15px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: #4a9e5b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .login-form button:hover {
            background-color: #3a7d48;
        }
        
        .owner-options {
            margin-top: 20px;
            text-align: center;
        }
        
        .owner-btn {
            background: none;
            border: none;
            color: #4a9e5b;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }
        
        .admin-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #1a311e;
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #2d4b32;
            margin-bottom: 20px;
        }
        
        .sidebar-header h2 {
            color: #f8a31c;
            font-size: 22px;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ddd;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: #2d4b32;
            color: white;
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            color: #4a9e5b;
            font-size: 24px;
        }
        
        .logout-btn {
            background-color: #f8a31c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background-color: #e5940c;
        }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card i {
            font-size: 36px;
            color: #4a9e5b;
            margin-bottom: 10px;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .stat-card p {
            color: #666;
            font-size: 14px;
        }
        
        /* Content Sections */
        .content-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .content-section h2 {
            margin-bottom: 15px;
            color: #4a9e5b;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn {
            background-color: #4a9e5b;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn:hover {
            background-color: #3a7d48;
        }
        
        .btn-secondary {
            background-color: #f8a31c;
        }
        
        .btn-secondary:hover {
            background-color: #e5940c;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        
        table tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-buttons button {
            padding: 5px 8px;
            font-size: 12px;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 500;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            border-radius: 8px;
            max-width: 800px;
            position: relative;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #333;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        /* Payment slip image */
        .payment-slip {
            max-width: 100%;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4a9e5b;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1050;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-error {
            background-color: #dc3545;
        }
        
        .notification-warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #4a9e5b;
            color: #4a9e5b;
            font-weight: 500;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* User Management */
        .user-list {
            margin-top: 20px;
        }
        
        .user-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info h3 {
            margin-bottom: 5px;
        }
        
        .user-info p {
            color: #666;
            font-size: 14px;
        }
        
        /* Developer Watermark */
        .developer-watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
        
        /* POS Styles */
        .pos-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .pos-products {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .pos-product-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .pos-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .pos-product-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .pos-product-card h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .pos-product-card p {
            color: #4a9e5b;
            font-weight: 500;
        }
        
        .pos-cart {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .pos-cart h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-info {
            flex: 2;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background-color: #f8a31c;
            color: white;
            cursor: pointer;
        }
        
        .cart-total {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
            text-align: right;
        }
        
        .payment-options {
            margin-bottom: 15px;
        }
        
        .payment-option {
            margin-bottom: 10px;
        }
        
        .table-selection {
            margin-bottom: 15px;
        }
        
        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .table-btn {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            text-align: center;
        }
        
        .table-btn.active {
            background-color: #4a9e5b;
            color: white;
            border-color: #4a9e5b;
        }
        
        .table-btn.occupied {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .pos-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Bill Styles */
        .bill-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .bill-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .bill-items {
            margin-bottom: 20px;
        }
        
        .bill-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .bill-total {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            text-align: right;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .pos-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>Scorpiora Admin Login</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <button class="btn" id="loginBtn">Login</button>
            
            <div class="owner-options">
                <button class="owner-btn" id="ownerBtn">Owner Options</button>
            </div>
        </div>
    </div>

    <!-- Owner Password Modal -->
    <div id="ownerPasswordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-modal" id="closeOwnerPasswordModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Owner Authentication</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ownerPassword">Enter Owner Password</label>
                    <input type="password" id="ownerPassword" placeholder="Enter owner password">
                </div>
                <button class="btn" id="submitOwnerPassword">Submit</button>
            </div>
        </div>
    </div>

    <!-- Owner Modal -->
    <div id="ownerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeOwnerModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Owner Options</h2>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-subtab="create-user">Create User</div>
                    <div class="tab" data-subtab="user-list">User List</div>
                </div>
                
                <div id="create-user" class="tab-content active">
                    <form id="createUserForm">
                        <div class="form-group">
                            <label for="newUsername">Username</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Password</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="userRole">Role</label>
                            <select id="userRole" required>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Access Control</label>
                            <div>
                                <label><input type="checkbox" name="access" value="dashboard" checked> Dashboard</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="orders" checked> Orders</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="products" checked> Products</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="categories" checked> Categories</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="bookings" checked> Bookings</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="points" checked> Points System</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="pos"> POS System</label>
                            </div>
                            <div>
                                <label><input type="checkbox" name="access" value="settings"> Settings</label>
                            </div>
                        </div>
                        <button type="submit" class="btn">Create User</button>
                    </form>
                </div>
                
                <div id="user-list" class="tab-content">
                    <div class="user-list" id="userListContainer">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Scorpiora Admin</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" data-tab="pos"><i class="fas fa-cash-register"></i> POS System</a></li>
                <li><a href="#" data-tab="orders"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                <li><a href="#" data-tab="products"><i class="fas fa-glass"></i> Products</a></li>
                <li><a href="#" data-tab="categories"><i class="fas fa-tags"></i> Categories</a></li>
                <li><a href="#" data-tab="bookings"><i class="fas fa-calendar-alt"></i> Bookings</a></li>
                <li><a href="#" data-tab="points"><i class="fas fa-coins"></i> Points System</a></li>
                <li><a href="#" data-tab="settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <div>
                    <span id="currentUserInfo" style="margin-right: 15px;"></span>
                    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-shopping-cart"></i>
                        <h3 id="totalOrders">0</h3>
                        <p>Total Orders</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt"></i>
                        <h3 id="totalBookings">0</h3>
                        <p>Total Bookings</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="totalCustomers">0</h3>
                        <p>Total Customers</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-coins"></i>
                        <h3 id="totalRevenue">MVR 0</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Sales Analytics</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="salesDateFrom">From:</label>
                            <input type="date" id="salesDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="salesDateTo">To:</label>
                            <input type="date" id="salesDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterSalesBtn">Filter</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportSalesExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportSalesPdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Sales data will be loaded here -->
                            </tbody>
                            <tfoot id="salesTableFooter">
                                <!-- Subtotal row will be added here -->
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Recent Orders</h2>
                    <div class="table-responsive">
                        <table id="recentOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Recent Bookings</h2>
                    <div class="table-responsive">
                        <table id="recentBookingsTable">
                            <thead>
                                <tr>
                                    <th>Booking #</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Bookings will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- POS System Tab -->
            <div id="pos" class="tab-content">
                <div class="content-section">
                    <h2>Point of Sale (POS) System</h2>
                    <div class="pos-container">
                        <div class="pos-products" id="posProducts">
                            <!-- Products will be loaded here -->
                        </div>
                        <div class="pos-cart">
                            <h3>Current Order</h3>
                            <div class="table-selection">
                                <label>Table Number:</label>
                                <div class="table-grid" id="tableGrid">
                                    <!-- Tables will be loaded here -->
                                </div>
                            </div>
                            <div class="cart-items" id="cartItems">
                                <!-- Cart items will be displayed here -->
                                <p class="empty-cart">No items added yet</p>
                            </div>
                            <div class="cart-total" id="cartTotal">
                                Total: MVR 0.00
                            </div>
                            <div class="payment-options">
                                <label>Payment Method:</label>
                                <div class="payment-option">
                                    <input type="radio" id="cashPayment" name="paymentMethod" value="cash" checked>
                                    <label for="cashPayment">Cash</label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="bankTransfer" name="paymentMethod" value="bank-transfer">
                                    <label for="bankTransfer">Bank Transfer</label>
                                </div>
                            </div>
                            <div class="pos-actions">
                                <button class="btn btn-danger" id="clearCartBtn">Clear</button>
                                <button class="btn btn-secondary" id="holdOrderBtn">Hold Order</button>
                                <button class="btn" id="completeOrderBtn">Complete Order</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <h2>Held Orders</h2>
                    <div class="table-responsive">
                        <table id="heldOrdersTable">
                            <thead>
                                <tr>
                                    <th>Table #</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Held orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <div class="content-section">
                    <h2>Order Management</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="orderStatusFilter">Status:</label>
                            <select id="orderStatusFilter">
                                <option value="">All</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="on-the-way">On the Way</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="orderDateFrom">From:</label>
                            <input type="date" id="orderDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="orderDateTo">To:</label>
                            <input type="date" id="orderDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterOrdersBtn">Filter</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportOrdersExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportOrdersPdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment Method</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders will be loaded here -->
                            </tbody>
                            <tfoot id="ordersTableFooter">
                                <!-- Subtotal row will be added here -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div class="content-section">
                    <h2>Product Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="product-list">Product List</div>
                        <div class="tab" data-subtab="add-product">Add New Product</div>
                    </div>

                    <div id="product-list" class="tab-content active">
                        <div class="table-responsive">
                            <table id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Featured</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Products will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="add-product" class="tab-content">
                        <form id="addProductForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productName">Product Name</label>
                                    <input type="text" id="productName" required>
                                </div>
                                <div class="form-group">
                                    <label for="productCategory">Category</label>
                                    <select id="productCategory" required>
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded here -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productPrice">Price (MVR)</label>
                                    <input type="number" id="productPrice" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="productOriginalPrice">Original Price (MVR)</label>
                                    <input type="number" id="productOriginalPrice" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productDescription">Description</label>
                                <textarea id="productDescription" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="productImage">Image URL</label>
                                <input type="text" id="productImage" required>
                            </div>
                            <div class="form-group">
                                <label for="productIngredients">Ingredients (comma separated)</label>
                                <input type="text" id="productIngredients">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="productFeatured"> Featured Product
                                </label>
                            </div>
                            <button type="submit" class="btn">Add Product</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content">
                <div class="content-section">
                    <h2>Category Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="category-list">Category List</div>
                        <div class="tab" data-subtab="add-category">Add New Category</div>
                    </div>

                    <div id="category-list" class="tab-content active">
                        <div class="table-responsive">
                            <table id="categoriesTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Categories will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="add-category" class="tab-content">
                        <form id="addCategoryForm">
                            <div class="form-group">
                                <label for="categoryName">Category Name</label>
                                <input type="text" id="categoryName" required>
                            </div>
                            <button type="submit" class="btn">Add Category</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Bookings Tab -->
            <div id="bookings" class="tab-content">
                <div class="content-section">
                    <h2>Booking Management</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="bookingStatusFilter">Status:</label>
                            <select id="bookingStatusFilter">
                                <option value="">All</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="bookingDateFrom">From:</label>
                            <input type="date" id="bookingDateFrom">
                        </div>
                        <div class="filter-group">
                            <label for="bookingDateTo">To:</label>
                            <input type="date" id="bookingDateTo">
                        </div>
                        <div class="filter-group">
                            <button class="btn" id="filterBookingsBtn">Filter</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportBookingsExcelBtn">Export Excel</button>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" id="exportBookingsPdfBtn">Export PDF</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="bookingsTable">
                            <thead>
                                <tr>
                                    <th>Booking #</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                            <tbody>
                                <!-- Bookings will be loaded here -->
                            </tbody>
                            <tfoot id="bookingsTableFooter">
                                <!-- Subtotal row will be added here -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Points System Tab -->
            <div id="points" class="tab-content">
                <div class="content-section">
                    <h2>Points System Management</h2>
                    <div class="tabs">
                        <div class="tab active" data-subtab="points-rules">Points Rules</div>
                        <div class="tab" data-subtab="customer-points">Customer Points</div>
                    </div>

                    <div id="points-rules" class="tab-content active">
                        <form id="pointsRulesForm">
                            <div class="form-group">
                                <label for="pointsPerOrder">Points per MVR 10 spent</label>
                                <input type="number" id="pointsPerOrder" min="1" value="1" required>
                            </div>
                            <h3>Rewards</h3>
                            <div id="rewardsContainer">
                                <!-- Rewards will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-secondary" id="addRewardBtn">Add Reward</button>
                            <button type="submit" class="btn">Save Rules</button>
                        </form>
                    </div>

                    <div id="customer-points" class="tab-content">
                        <div class="filters">
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportPointsExcelBtn">Export Excel</button>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" id="exportPointsPdfBtn">Export PDF</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="customerPointsTable">
                                <thead>
                                    <tr>
                                        <th>Phone</th>
                                        <th>Points</th>
                                        <th>First Order</th>
                                        <th>Last Order</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Customer points will be loaded here -->
                                </tbody>
                                <tfoot id="pointsTableFooter">
                                    <!-- Subtotal row will be added here -->
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="content-section">
                    <h2>Store Settings</h2>
                    <form id="storeSettingsForm">
                        <div class="form-group">
                            <label for="storeName">Store Name</label>
                            <input type="text" id="storeName" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="freeShippingThreshold">Free Shipping Threshold (MVR)</label>
                                <input type="number" id="freeShippingThreshold" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="shippingCost">Shipping Cost (MVR)</label>
                                <input type="number" id="shippingCost" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="storePhone">Store Phone</label>
                            <input type="tel" id="storePhone" required>
                        </div>
                        <div class="form-group">
                            <label for="storeEmail">Store Email</label>
                            <input type="email" id="storeEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="storeAddress">Store Address</label>
                            <textarea id="storeAddress" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="tablesCount">Number of Tables</label>
                            <input type="number" id="tablesCount" min="1" max="50" value="10" required>
                        </div>
                        <button type="submit" class="btn">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeOrderModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Order Details</h2>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteOrderBtn">Delete Order</button>
                <button class="btn" id="closeOrderModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Booking Detail Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeBookingModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Booking Details</h2>
            </div>
            <div class="modal-body" id="bookingModalBody">
                <!-- Booking details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteBookingBtn">Delete Booking</button>
                <button class="btn" id="closeBookingModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Bill Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" id="closeBillModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>Order Bill</h2>
            </div>
            <div class="modal-body" id="billModalBody">
                <!-- Bill will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="printBillBtn">Print Bill</button>
                <button class="btn" id="closeBillModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Developer Watermark -->
    <div class="developer-watermark">
        Developed by sym.codermv © 2025
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBaH7VIeztJDWeHeeiMXgL1KiNA1nhGMCY",
            authDomain: "fresh-8dc18.firebaseapp.com",
            projectId: "fresh-8dc18",
            storageBucket: "fresh-8dc18.firebasestorage.app",
            messagingSenderId: "202478209202",
            appId: "1:202478209202:web:4d692f1c5cfb1178db21ab",
            measurementId: "G-8KF5VX8KQ3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentOrderId = null;
        let currentBookingId = null;
        let currentUser = null;
        let userAccess = [];
        let cart = [];
        let currentTable = null;
        let tablesCount = 10;
        let heldOrders = {};
        let notifiedOrders = {}; // Track which orders have been notified

        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const adminPanel = document.getElementById('adminPanel');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const ownerBtn = document.getElementById('ownerBtn');
        const ownerModal = document.getElementById('ownerModal');
        const ownerPasswordModal = document.getElementById('ownerPasswordModal');
        const closeOwnerModal = document.getElementById('closeOwnerModal');
        const closeOwnerPasswordModal = document.getElementById('closeOwnerPasswordModal');
        const submitOwnerPassword = document.getElementById('submitOwnerPassword');
        const createUserForm = document.getElementById('createUserForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const tabContents = document.querySelectorAll('.tab-content');
        const subtabTabs = document.querySelectorAll('[data-subtab]');
        const subtabContents = document.querySelectorAll('.tab-content .tab-content');
        const orderModal = document.getElementById('orderModal');
        const bookingModal = document.getElementById('bookingModal');
        const billModal = document.getElementById('billModal');
        const notificationContainer = document.getElementById('notificationContainer');
        const currentUserInfo = document.getElementById('currentUserInfo');

        // POS elements
        const posProducts = document.getElementById('posProducts');
        const tableGrid = document.getElementById('tableGrid');
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const holdOrderBtn = document.getElementById('holdOrderBtn');
        const completeOrderBtn = document.getElementById('completeOrderBtn');
        const heldOrdersTable = document.getElementById('heldOrdersTable').querySelector('tbody');
        const printBillBtn = document.getElementById('printBillBtn');
        const closeBillModal = document.getElementById('closeBillModal');
        const closeBillModalBtn = document.getElementById('closeBillModalBtn');

        // Initialize the admin panel
        function initAdmin() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userAccess = currentUser.access || [];
                showAdminPanel();
                updateUserInterface();
            } else {
                showLoginScreen();
            }

            // Login button event
            loginBtn.addEventListener('click', handleLogin);

            // Owner button event
            ownerBtn.addEventListener('click', () => {
                ownerPasswordModal.style.display = 'block';
            });

            // Owner password submission
            submitOwnerPassword.addEventListener('click', () => {
                const password = document.getElementById('ownerPassword').value;
                if (password === '8555') {
                    ownerPasswordModal.style.display = 'none';
                    ownerModal.style.display = 'block';
                    loadUsers();
                } else {
                    showNotification('Invalid owner password', 'error');
                }
            });

            // Close owner modals
            closeOwnerModal.addEventListener('click', () => {
                ownerModal.style.display = 'none';
            });
            
            closeOwnerPasswordModal.addEventListener('click', () => {
                ownerPasswordModal.style.display = 'none';
            });

            // Create user form
            createUserForm.addEventListener('submit', createUser);

            // Logout button event
            logoutBtn.addEventListener('click', handleLogout);

            // Sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = link.dataset.tab;
                    
                    // Check if user has access to this tab
                    if (!userAccess.includes(tab) && tab !== 'dashboard') {
                        showNotification('You do not have access to this section', 'error');
                        return;
                    }
                    
                    switchTab(tab);
                    
                    // Update active state
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            // Sub-tab navigation
            subtabTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const subtab = tab.dataset.subtab;
                    switchSubTab(subtab);
                    
                    // Update active state
                    subtabTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Modal close buttons
            document.getElementById('closeOrderModal').addEventListener('click', () => orderModal.style.display = 'none');
            document.getElementById('closeOrderModalBtn').addEventListener('click', () => orderModal.style.display = 'none');
            document.getElementById('closeBookingModal').addEventListener('click', () => bookingModal.style.display = 'none');
            document.getElementById('closeBookingModalBtn').addEventListener('click', () => bookingModal.style.display = 'none');
            closeBillModal.addEventListener('click', () => billModal.style.display = 'none');
            closeBillModalBtn.addEventListener('click', () => billModal.style.display = 'none');

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === orderModal) orderModal.style.display = 'none';
                if (e.target === bookingModal) bookingModal.style.display = 'none';
                if (e.target === ownerModal) ownerModal.style.display = 'none';
                if (e.target === ownerPasswordModal) ownerPasswordModal.style.display = 'none';
                if (e.target === billModal) billModal.style.display = 'none';
            });

            // Delete buttons
            document.getElementById('deleteOrderBtn').addEventListener('click', deleteOrder);
            document.getElementById('deleteBookingBtn').addEventListener('click', deleteBooking);

            // Filter buttons
            document.getElementById('filterSalesBtn').addEventListener('click', filterSales);
            document.getElementById('filterOrdersBtn').addEventListener('click', loadOrders);
            document.getElementById('filterBookingsBtn').addEventListener('click', loadBookings);

            // Export buttons
            document.getElementById('exportSalesExcelBtn').addEventListener('click', () => exportToExcel('sales'));
            document.getElementById('exportSalesPdfBtn').addEventListener('click', () => exportToPdf('sales'));
            document.getElementById('exportOrdersExcelBtn').addEventListener('click', () => exportToExcel('orders'));
            document.getElementById('exportOrdersPdfBtn').addEventListener('click', () => exportToPdf('orders'));
            document.getElementById('exportBookingsExcelBtn').addEventListener('click', () => exportToExcel('bookings'));
            document.getElementById('exportBookingsPdfBtn').addEventListener('click', () => exportToPdf('bookings'));
            document.getElementById('exportPointsExcelBtn').addEventListener('click', () => exportToExcel('points'));
            document.getElementById('exportPointsPdfBtn').addEventListener('click', () => exportToPdf('points'));

            // Form submissions
            document.getElementById('addProductForm').addEventListener('submit', addProduct);
            document.getElementById('addCategoryForm').addEventListener('submit', addCategory);
            document.getElementById('pointsRulesForm').addEventListener('submit', savePointsRules);
            document.getElementById('storeSettingsForm').addEventListener('submit', saveStoreSettings);

            // Add reward button
            document.getElementById('addRewardBtn').addEventListener('click', addNewReward);

            // POS buttons
            clearCartBtn.addEventListener('click', clearCart);
            holdOrderBtn.addEventListener('click', holdOrder);
            completeOrderBtn.addEventListener('click', completeOrder);
            printBillBtn.addEventListener('click', printBill);

            // Load initial data if logged in
            if (savedUser) {
                loadDashboardData();
                loadProducts();
                loadCategories();
                loadOrders();
                loadBookings();
                loadPointsRules();
                loadCustomerPoints();
                loadStoreSettings();
                loadTables();
                loadHeldOrders();
                
                // Set up real-time listeners
                setupRealtimeListeners();
            }
        }

        // Handle login
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            database.ref('adminUsers').once('value').then(snapshot => {
                const users = snapshot.val();
                let authenticated = false;
                
                if (users) {
                    Object.entries(users).forEach(([id, user]) => {
                        if (user.username === username && user.password === password) {
                            authenticated = true;
                            currentUser = { id, ...user };
                            userAccess = user.access || [];
                            
                            // Save to localStorage
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            
                            showAdminPanel();
                            updateUserInterface();
                            loadDashboardData();
                            loadProducts();
                            loadCategories();
                            loadOrders();
                            loadBookings();
                            loadPointsRules();
                            loadCustomerPoints();
                            loadStoreSettings();
                            loadTables();
                            loadHeldOrders();
                            
                            // Set up real-time listeners
                            setupRealtimeListeners();
                        }
                    });
                }
                
                if (!authenticated) {
                    showNotification('Invalid username or password', 'error');
                }
            }).catch(error => {
                showNotification('Error during login: ' + error.message, 'error');
            });
        }

        // Create new user
        function createUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('userRole').value;
            
            // Get access controls
            const access = [];
            document.querySelectorAll('input[name="access"]:checked').forEach(checkbox => {
                access.push(checkbox.value);
            });
            
            const newUser = {
                username,
                password,
                role,
                access,
                createdAt: new Date().toISOString()
            };
            
            database.ref('adminUsers').push(newUser)
                .then(() => {
                    showNotification('User created successfully!');
                    createUserForm.reset();
                    loadUsers();
                })
                .catch(error => {
                    showNotification('Error creating user: ' + error.message, 'error');
                });
        }

        // Load users for owner modal
        function loadUsers() {
            database.ref('adminUsers').once('value').then(snapshot => {
                const users = snapshot.val();
                const userListContainer = document.getElementById('userListContainer');
                userListContainer.innerHTML = '';
                
                if (users) {
                    Object.entries(users).forEach(([id, user]) => {
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `
                            <div class="user-info">
                                <h3>${user.username}</h3>
                                <p>Role: ${user.role} | Access: ${user.access.join(', ')}</p>
                                <p>Created: ${new Date(user.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-danger delete-user" data-id="${id}">Delete</button>
                            </div>
                        `;
                        userListContainer.appendChild(userCard);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-user').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const userId = btn.dataset.id;
                            deleteUser(userId);
                        });
                    });
                }
            });
        }

        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                database.ref('adminUsers/' + userId).remove()
                    .then(() => {
                        showNotification('User deleted successfully!');
                        loadUsers();
                    })
                    .catch(error => {
                        showNotification('Error deleting user: ' + error.message, 'error');
                    });
            }
        }

        // Update user interface based on access
        function updateUserInterface() {
            // Update user info in header
            currentUserInfo.textContent = `Logged in as: ${currentUser.username} (${currentUser.role})`;
            
            // Hide sidebar items based on access
            sidebarLinks.forEach(link => {
                const tab = link.dataset.tab;
                if (tab !== 'dashboard' && !userAccess.includes(tab)) {
                    link.style.display = 'none';
                } else {
                    link.style.display = 'flex';
                }
            });
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            userAccess = [];
            showLoginScreen();
        }

        // Show login screen
        function showLoginScreen() {
            loginScreen.style.display = 'flex';
            adminPanel.style.display = 'none';
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // Show admin panel
        function showAdminPanel() {
            loginScreen.style.display = 'none';
            adminPanel.style.display = 'flex';
        }

        // Switch between main tabs
        function switchTab(tab) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab).classList.add('active');
            
            // Update header title
            document.querySelector('.header h1').textContent = getTabTitle(tab);
            
            // Load specific data for certain tabs
            if (tab === 'pos') {
                loadProductsForPOS();
                loadHeldOrders();
            }
        }

        // Switch between sub-tabs
        function switchSubTab(subtab) {
            subtabContents.forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subtab).classList.add('active');
        }

        // Get tab title
        function getTabTitle(tab) {
            const titles = {
                'dashboard': 'Admin Dashboard',
                'pos': 'POS System',
                'products': 'Product Management',
                'categories': 'Category Management',
                'orders': 'Order Management',
                'bookings': 'Booking Management',
                'points': 'Points System Management',
                'settings': 'Store Settings'
            };
            return titles[tab] || 'Admin Dashboard';
        }

        // Set up real-time listeners for new orders
        function setupRealtimeListeners() {
            // Listen for new orders (only show notification for new orders)
            database.ref('orders').orderByChild('createdAt').on('child_added', (snapshot) => {
                const order = snapshot.val();
                const orderId = snapshot.key;
                
                // Only show notification if this is a new order that hasn't been notified yet
                if (!notifiedOrders[orderId] && order.status === 'pending') {
                    notifiedOrders[orderId] = true;
                    showNotification(`New order received: ${order.orderNumber} from ${order.shippingInfo?.name}`, 'success');
                }
                
                loadDashboardData();
                loadOrders();
            });
            
            // Listen for new bookings
            database.ref('bookings').orderByChild('createdAt').on('child_added', (snapshot) => {
                const booking = snapshot.val();
                const bookingId = snapshot.key;
                
                // Only show notification if this is a new booking that hasn't been notified yet
                if (!notifiedOrders[bookingId] && booking.status === 'pending') {
                    notifiedOrders[bookingId] = true;
                    showNotification(`New booking received: ${booking.bookingRef} for ${booking.type}`, 'success');
                }
                
                loadDashboardData();
                loadBookings();
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'notification-error' : type === 'warning' ? 'notification-warning' : ''}`;
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
                <button class="close-notification"><i class="fas fa-times"></i></button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Add event listener to close button
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load dashboard data
        function loadDashboardData() {
            // Load orders count
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                const ordersCount = orders ? Object.keys(orders).length : 0;
                document.getElementById('totalOrders').textContent = ordersCount;
                
                // Calculate total revenue
                let totalRevenue = 0;
                if (orders) {
                    Object.values(orders).forEach(order => {
                        if (order.status !== 'cancelled') {
                            totalRevenue += order.total || 0;
                        }
                    });
                }
                document.getElementById('totalRevenue').textContent = `MVR ${totalRevenue.toFixed(2)}`;
                
                // Load recent orders
                const recentOrdersTable = document.getElementById('recentOrdersTable').querySelector('tbody');
                recentOrdersTable.innerHTML = '';
                
                if (orders) {
                    const recentOrders = Object.entries(orders)
                        .sort((a, b) => new Date(b[1].createdAt || 0) - new Date(a[1].createdAt || 0))
                        .slice(0, 5);
                    
                    recentOrders.forEach(([id, order]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.orderNumber || id}</td>
                            <td>${order.shippingInfo?.name || 'N/A'}</td>
                            <td>${order.date || 'N/A'}</td>
                            <td>MVR ${order.total?.toFixed(2) || '0.00'}</td>
                            <td>${order.status || 'pending'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-order" data-id="${id}">View</button>
                                ${userAccess.includes('orders') ? `<button class="btn btn-danger delete-order" data-id="${id}">Delete</button>` : ''}
                            </td>
                        `;
                        recentOrdersTable.appendChild(row);
                    });
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const orderId = btn.dataset.id;
                            viewOrder(orderId);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const orderId = btn.dataset.id;
                            if (confirm('Are you sure you want to delete this order?')) {
                                deleteOrder(orderId);
                            }
                        });
                    });
                }
            });
            
            // Load bookings count
            database.ref('bookings').once('value').then(snapshot => {
                const bookings = snapshot.val();
                const bookingsCount = bookings ? Object.keys(bookings).length : 0;
                document.getElementById('totalBookings').textContent = bookingsCount;
                
                // Load recent bookings
                const recentBookingsTable = document.getElementById('recentBookingsTable').querySelector('tbody');
                recentBookingsTable.innerHTML = '';
                
                if (bookings) {
                    const recentBookings = Object.entries(bookings)
                        .sort((a, b) => new Date(b[1].createdAt || 0) - new Date(a[1].createdAt || 0))
                        .slice(0, 5);
                    
                    recentBookings.forEach(([id, booking]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${booking.bookingRef || id}</td>
                            <td>${booking.name || 'N/A'}</td>
                            <td>${booking.date || 'N/A'}</td>
                            <td>${booking.type || 'N/A'}</td>
                            <td>${booking.status || 'pending'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-booking" data-id="${id}">View</button>
                                ${userAccess.includes('bookings') ? `<button class="btn btn-danger delete-booking" data-id="${id}">Delete</button>` : ''}
                            </td>
                        `;
                        recentBookingsTable.appendChild(row);
                    });
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-booking').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const bookingId = btn.dataset.id;
                            viewBooking(bookingId);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-booking').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const bookingId = btn.dataset.id;
                            if (confirm('Are you sure you want to delete this booking?')) {
                                deleteBooking(bookingId);
                            }
                        });
                    });
                }
            });
            
            // Load customers count
            database.ref('customerPoints').once('value').then(snapshot => {
                const customers = snapshot.val();
                const customersCount = customers ? Object.keys(customers).length : 0;
                document.getElementById('totalCustomers').textContent = customersCount;
            });
            
            // Load sales data
            filterSales();
        }

        // Filter sales data
        function filterSales() {
            const dateFrom = document.getElementById('salesDateFrom').value;
            const dateTo = document.getElementById('salesDateTo').value;
            
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                const salesTable = document.getElementById('salesTable').querySelector('tbody');
                const salesTableFooter = document.getElementById('salesTableFooter');
                salesTable.innerHTML = '';
                salesTableFooter.innerHTML = '';
                
                let totalAmount = 0;
                let orderCount = 0;
                
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        // Filter by date if specified
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        const amount = order.total || 0;
                        totalAmount += amount;
                        orderCount++;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.date || 'N/A'}</td>
                            <td>${order.orderNumber || id}</td>
                            <td>${order.shippingInfo?.name || 'N/A'}</td>
                            <td>MVR ${amount.toFixed(2)}</td>
                            <td>${order.status || 'pending'}</td>
                        `;
                        salesTable.appendChild(row);
                    });
                    
                    // Add subtotal row
                    if (orderCount > 0) {
                        const footerRow = document.createElement('tr');
                        footerRow.style.fontWeight = 'bold';
                        footerRow.innerHTML = `
                            <td colspan="3">Subtotal (${orderCount} orders)</td>
                            <td>MVR ${totalAmount.toFixed(2)}</td>
                            <td></td>
                        `;
                        salesTableFooter.appendChild(footerRow);
                    }
                }
            });
        }

        // Load products for POS
        function loadProductsForPOS() {
            if (!userAccess.includes('pos')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                posProducts.innerHTML = '';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        const productCard = document.createElement('div');
                        productCard.className = 'pos-product-card';
                        productCard.innerHTML = `
                            <img src="${product.image}" alt="${product.name}">
                            <h3>${product.name}</h3>
                            <p>MVR ${product.price?.toFixed(2) || '0.00'}</p>
                        `;
                        productCard.addEventListener('click', () => {
                            addToCart(id, product);
                        });
                        posProducts.appendChild(productCard);
                    });
                }
            });
        }

        // Load tables
        function loadTables() {
            database.ref('tables').once('value').then(snapshot => {
                const tables = snapshot.val();
                tableGrid.innerHTML = '';
                
                // Create table buttons
                for (let i = 1; i <= tablesCount; i++) {
                    const tableBtn = document.createElement('div');
                    tableBtn.className = 'table-btn';
                    tableBtn.textContent = i;
                    tableBtn.dataset.table = i;
                    
                    // Check if table is occupied
                    if (tables && tables[i] && tables[i].status === 'occupied') {
                        tableBtn.classList.add('occupied');
                    }
                    
                    tableBtn.addEventListener('click', () => {
                        selectTable(i);
                    });
                    
                    tableGrid.appendChild(tableBtn);
                }
            });
        }

        // Select table
        function selectTable(tableNumber) {
            // Deselect all tables
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Select the clicked table
            const tableBtn = document.querySelector(`.table-btn[data-table="${tableNumber}"]`);
            tableBtn.classList.add('active');
            
            currentTable = tableNumber;
            
            // Load any held order for this table
            loadHeldOrderForTable(tableNumber);
        }

        // Add to cart
        function addToCart(productId, product) {
            if (!currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            // Check if product already in cart
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCart();
        }

        // Update cart display
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">No items added yet</p>';
                cartTotal.textContent = 'Total: MVR 0.00';
                return;
            }
            
            let total = 0;
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div>${item.name}</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease-btn" data-index="${index}">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn increase-btn" data-index="${index}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        MVR ${itemTotal.toFixed(2)}
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `Total: MVR ${total.toFixed(2)}`;
            
            // Add event listeners to quantity buttons
            document.querySelectorAll('.decrease-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    decreaseQuantity(index);
                });
            });
            
            document.querySelectorAll('.increase-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    increaseQuantity(index);
                });
            });
        }

        // Decrease item quantity
        function decreaseQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        }

        // Increase item quantity
        function increaseQuantity(index) {
            cart[index].quantity++;
            updateCart();
        }

        // Clear cart
        function clearCart() {
            cart = [];
            updateCart();
        }

        // Hold order
        function holdOrder() {
            if (!currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            const order = {
                table: currentTable,
                items: [...cart],
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                createdAt: new Date().toISOString()
            };
            
            database.ref('heldOrders/' + currentTable).set(order)
                .then(() => {
                    showNotification(`Order held for Table ${currentTable}`);
                    clearCart();
                    loadHeldOrders();
                    
                    // Mark table as occupied
                    database.ref('tables/' + currentTable).set({
                        status: 'occupied',
                        orderId: currentTable
                    }).then(() => {
                        loadTables();
                    });
                })
                .catch(error => {
                    showNotification('Error holding order: ' + error.message, 'error');
                });
        }

        // Load held orders
        function loadHeldOrders() {
            database.ref('heldOrders').once('value').then(snapshot => {
                const orders = snapshot.val();
                heldOrdersTable.innerHTML = '';
                
                if (orders) {
                    Object.entries(orders).forEach(([tableNumber, order]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${tableNumber}</td>
                            <td>${order.items.length} items</td>
                            <td>MVR ${order.total.toFixed(2)}</td>
                            <td>${new Date(order.createdAt).toLocaleTimeString()}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary load-held-order" data-table="${tableNumber}">Load</button>
                                <button class="btn btn-danger delete-held-order" data-table="${tableNumber}">Delete</button>
                            </td>
                        `;
                        heldOrdersTable.appendChild(row);
                    });
                    
                    // Add event listeners to load buttons
                    document.querySelectorAll('.load-held-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const tableNumber = btn.dataset.table;
                            loadHeldOrderForTable(tableNumber);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-held-order').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const tableNumber = btn.dataset.table;
                            deleteHeldOrder(tableNumber);
                        });
                    });
                }
            });
        }

        // Load held order for table
        function loadHeldOrderForTable(tableNumber) {
            database.ref('heldOrders/' + tableNumber).once('value').then(snapshot => {
                const order = snapshot.val();
                if (order) {
                    // Select the table
                    selectTable(parseInt(tableNumber));
                    
                    // Load items to cart
                    cart = order.items;
                    updateCart();
                    
                    showNotification(`Loaded held order for Table ${tableNumber}`);
                }
            });
        }

        // Delete held order
        function deleteHeldOrder(tableNumber) {
            if (confirm('Are you sure you want to delete this held order?')) {
                database.ref('heldOrders/' + tableNumber).remove()
                    .then(() => {
                        // Mark table as available
                        database.ref('tables/' + tableNumber).remove()
                            .then(() => {
                                showNotification('Held order deleted');
                                loadHeldOrders();
                                loadTables();
                            });
                    })
                    .catch(error => {
                        showNotification('Error deleting held order: ' + error.message, 'error');
                    });
            }
        }

        // Complete order
        function completeOrder() {
            if (!currentTable) {
                showNotification('Please select a table first', 'error');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Cart is empty', 'error');
                return;
            }
            
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const orderNumber = generateOrderNumber();
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const order = {
                orderNumber,
                items: cart,
                total,
                paymentMethod,
                table: currentTable,
                status: 'completed',
                createdAt: new Date().toISOString()
            };
            
            // Save order
            database.ref('posOrders').push(order)
                .then(() => {
                    // Remove any held order for this table
                    database.ref('heldOrders/' + currentTable).remove();
                    
                    // Mark table as available
                    database.ref('tables/' + currentTable).remove();
                    
                    showNotification(`Order completed for Table ${currentTable}`);
                    generateBill(order);
                    clearCart();
                    loadHeldOrders();
                    loadTables();
                })
                .catch(error => {
                    showNotification('Error completing order: ' + error.message, 'error');
                });
        }

        // Generate order number
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().substr(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `POS-${year}${month}${day}-${random}`;
        }

        // Generate bill
        function generateBill(order) {
            const billModalBody = document.getElementById('billModalBody');
            let billHTML = `
                <div class="bill-container">
                    <div class="bill-header">
                        <h2>${document.getElementById('storeName').value || 'Scorpiora'}</h2>
                        <p>${document.getElementById('storeAddress').value || ''}</p>
                        <p>Tel: ${document.getElementById('storePhone').value || ''}</p>
                        <p>Order #: ${order.orderNumber}</p>
                        <p>Date: ${new Date().toLocaleString()}</p>
                        <p>Table: ${order.table}</p>
                    </div>
                    <div class="bill-items">
            `;
            
            order.items.forEach(item => {
                billHTML += `
                    <div class="bill-item">
                        <div>${item.name} x ${item.quantity}</div>
                        <div>MVR ${(item.price * item.quantity).toFixed(2)}</div>
                    </div>
                `;
            });
            
            billHTML += `
                    </div>
                    <div class="bill-total">
                        Total: MVR ${order.total.toFixed(2)}
                    </div>
                    <div class="payment-method">
                        Payment Method: ${order.paymentMethod === 'cash' ? 'Cash' : 'Bank Transfer'}
                    </div>
                    <div class="thank-you">
                        <p>Thank you for your visit!</p>
                    </div>
                </div>
            `;
            
            billModalBody.innerHTML = billHTML;
            billModal.style.display = 'block';
        }

        // Print bill
        function printBill() {
            const printContent = document.getElementById('billModalBody').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Reinitialize event listeners
            initAdmin();
        }

        // Load products
        function loadProducts() {
            if (!userAccess.includes('products')) return;
            
            database.ref('products').once('value').then(snapshot => {
                const products = snapshot.val();
                const productsTable = document.getElementById('productsTable').querySelector('tbody');
                productsTable.innerHTML = '';
                
                if (products) {
                    Object.entries(products).forEach(([id, product]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>MVR ${product.price?.toFixed(2) || '0.00'}</td>
                            <td>${product.featured ? 'Yes' : 'No'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary edit-product" data-id="${id}">Edit</button>
                                <button class="btn btn-danger delete-product" data-id="${id}">Delete</button>
                            </td>
                        `;
                        productsTable.appendChild(row);
                    });
                }
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-product').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        editProduct(productId);
                    });
                });
                
                document.querySelectorAll('.delete-product').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.id;
                        deleteProduct(productId);
                    });
                });
            });
        }

        // Load categories
        function loadCategories() {
            if (!userAccess.includes('categories')) return;
            
            database.ref('categories').once('value').then(snapshot => {
                const categories = snapshot.val();
                const categoriesTable = document.getElementById('categoriesTable').querySelector('tbody');
                const categorySelect = document.getElementById('productCategory');
                
                categoriesTable.innerHTML = '';
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                if (categories) {
                    Object.entries(categories).forEach(([id, category]) => {
                        // Add to table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${category}</td>
                            <td class="action-buttons">
                                <button class="btn btn-danger delete-category" data-id="${id}">Delete</button>
                            </td>
                        `;
                        categoriesTable.appendChild(row);
                        
                        // Add to select
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                }
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-category').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const categoryId = btn.dataset.id;
                        deleteCategory(categoryId);
                    });
                });
            });
        }

        // Load orders with filters
        function loadOrders() {
            if (!userAccess.includes('orders')) return;
            
            const statusFilter = document.getElementById('orderStatusFilter').value;
            const dateFrom = document.getElementById('orderDateFrom').value;
            const dateTo = document.getElementById('orderDateTo').value;
            
            database.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val();
                const ordersTable = document.getElementById('ordersTable').querySelector('tbody');
                const ordersTableFooter = document.getElementById('ordersTableFooter');
                ordersTable.innerHTML = '';
                ordersTableFooter.innerHTML = '';
                
                let totalAmount = 0;
                let orderCount = 0;
                
                if (orders) {
                    Object.entries(orders).forEach(([id, order]) => {
                        // Apply filters
                        if (statusFilter && order.status !== statusFilter) return;
                        if (dateFrom && order.date < dateFrom) return;
                        if (dateTo && order.date > dateTo) return;
                        
                        const amount = order.total || 0;
                        totalAmount += amount;
                        orderCount++;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${order.orderNumber || id}</td>
                            <td>${order.shippingInfo?.name || 'N/A'}</td>
                            <td>${order.date || 'N/A'}</td>
                            <td>MVR ${amount.toFixed(2)}</td>
                            <td>${order.paymentMethod || 'N/A'}</td>
                            <td>
                                <select class="order-status-select" data-id="${id}">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                    <option value="on-the-way" ${order.status === 'on-the-way' ? 'selected' : ''}>On the Way</option>
                                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-order" data-id="${id}">View</button>
                                <button class="btn btn-danger delete-order" data-id="${id}">Delete</button>
                            </td>
                        `;
                        ordersTable.appendChild(row);
                    });
                    
                    // Add subtotal row
                    if (orderCount > 0) {
                        const footerRow = document.createElement('tr');
                        footerRow.style.fontWeight = 'bold';
                        footerRow.innerHTML = `
                            <td colspan="3">Subtotal (${orderCount} orders)</td>
                            <td>MVR ${totalAmount.toFixed(2)}</td>
                            <td colspan="3"></td>
                        `;
                        ordersTableFooter.appendChild(footerRow);
                    }
                }
                
                // Add event listeners to status selects
                document.querySelectorAll('.order-status-select').forEach(select => {
                    select.addEventListener('change', () => {
                        const orderId = select.dataset.id;
                        const newStatus = select.value;
                        updateOrderStatus(orderId, newStatus);
                    });
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-order').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.dataset.id;
                        viewOrder(orderId);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-order').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const orderId = btn.dataset.id;
                        if (confirm('Are you sure you want to delete this order?')) {
                            deleteOrder(orderId);
                        }
                    });
                });
            });
        }

        // Load bookings with filters
        function loadBookings() {
            if (!userAccess.includes('bookings')) return;
            
            const statusFilter = document.getElementById('bookingStatusFilter').value;
            const dateFrom = document.getElementById('bookingDateFrom').value;
            const dateTo = document.getElementById('bookingDateTo').value;
            
            database.ref('bookings').once('value').then(snapshot => {
                const bookings = snapshot.val();
                const bookingsTable = document.getElementById('bookingsTable').querySelector('tbody');
                const bookingsTableFooter = document.getElementById('bookingsTableFooter');
                bookingsTable.innerHTML = '';
                bookingsTableFooter.innerHTML = '';
                
                let bookingCount = 0;
                
                if (bookings) {
                    Object.entries(bookings).forEach(([id, booking]) => {
                        // Apply filters
                        if (statusFilter && booking.status !== statusFilter) return;
                        if (dateFrom && booking.date < dateFrom) return;
                        if (dateTo && booking.date > dateTo) return;
                        
                        bookingCount++;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${booking.bookingRef || id}</td>
                            <td>${booking.name || 'N/A'}</td>
                            <td>${booking.phone || 'N/A'}</td>
                            <td>${booking.date || 'N/A'}</td>
                            <td>${booking.type || 'N/A'}</td>
                            <td>
                                <select class="booking-status-select" data-id="${id}">
                                    <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary view-booking" data-id="${id}">View</button>
                                <button class="btn btn-danger delete-booking" data-id="${id}">Delete</button>
                            </td>
                        `;
                        bookingsTable.appendChild(row);
                    });
                    
                    // Add subtotal row
                    if (bookingCount > 0) {
                        const footerRow = document.createElement('tr');
                        footerRow.style.fontWeight = 'bold';
                        footerRow.innerHTML = `
                            <td colspan="3">Subtotal (${bookingCount} bookings)</td>
                            <td colspan="4"></td>
                        `;
                        bookingsTableFooter.appendChild(footerRow);
                    }
                }
                
                // Add event listeners to status selects
                document.querySelectorAll('.booking-status-select').forEach(select => {
                    select.addEventListener('change', () => {
                        const bookingId = select.dataset.id;
                        const newStatus = select.value;
                        updateBookingStatus(bookingId, newStatus);
                    });
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-booking').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const bookingId = btn.dataset.id;
                        viewBooking(bookingId);
                        loadBookings();
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-booking').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const bookingId = btn.dataset.id;
                        if (confirm('Are you sure you want to delete this booking?')) {
                            deleteBooking(bookingId);
                        }
                    });
                });
            });
        }

        // View order details
        function viewOrder(orderId) {
            database.ref('orders/' + orderId).once('value').then(snapshot => {
                const order = snapshot.val();
                if (!order) return;
                
                currentOrderId = orderId;
                
                const modalBody = document.getElementById('orderModalBody');
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>Order Number</label>
                        <p>${order.orderNumber || orderId}</p>
                    </div>
                    <div class="form-group">
                        <label>Order Date</label>
                        <p>${order.date || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Customer Name</label>
                        <p>${order.shippingInfo?.name || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Customer Phone</label>
                        <p>${order.shippingInfo?.phone || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Shipping Address</label>
                        <p>${order.shippingInfo?.address || 'N/A'}, ${order.shippingInfo?.island || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <p>${order.paymentMethod || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <p>${order.status || 'pending'}</p>
                    </div>
                    <div class="form-group">
                        <label>Total Amount</label>
                        <p>MVR ${order.total?.toFixed(2) || '0.00'}</p>
                    </div>
                    ${order.paymentSlip ? `
                    <div class="form-group">
                        <label>Payment Slip</label>
                        <img src="${order.paymentSlip}" alt="Payment Slip" class="payment-slip">
                    </div>
                    ` : ''}
                    <div class="form-group">
                        <label>Items</label>
                        <ul>
                            ${order.items ? order.items.map(item => `
                                <li>${item.product.name} x ${item.quantity} - MVR ${(item.product.price * item.quantity).toFixed(2)}</li>
                            `).join('') : '<li>No items</li>'}
                        </ul>
                    </div>
                `;
                
                orderModal.style.display = 'block';
            });
        }

        // View booking details
        function viewBooking(bookingId) {
            database.ref('bookings/' + bookingId).once('value').then(snapshot => {
                const booking = snapshot.val();
                if (!booking) return;
                
                currentBookingId = bookingId;
                
                const modalBody = document.getElementById('bookingModalBody');
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>Booking Reference</label>
                        <p>${booking.bookingRef || bookingId}</p>
                    </div>
                    <div class="form-group">
                        <label>Customer Name</label>
                        <p>${booking.name || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Customer Phone</label>
                        <p>${booking.phone || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Booking Date</label>
                        <p>${booking.date || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Booking Time</label>
                        <p>${booking.time || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Booking Type</label>
                        <p>${booking.type || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <p>${booking.duration || 'N/A'} hours</p>
                    </div>
                    <div class="form-group">
                        <label>Number of People</label>
                        <p>${booking.people || booking.guests || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <p>${booking.status || 'pending'}</p>
                    </div>
                    ${booking.requests ? `
                    <div class="form-group">
                        <label>Special Requests</label>
                        <p>${booking.requests}</p>
                    </div>
                    ` : ''}
                    ${booking.requirements ? `
                    <div class="form-group">
                        <label>Special Requirements</label>
                        <p>${booking.requirements}</p>
                    </div>
                    ` : ''}
                `;
                
                bookingModal.style.display = 'block';
            });
        }

        // Delete order
        function deleteOrder(orderId = null) {
            const idToDelete = orderId || currentOrderId;
            if (!idToDelete) return;
            
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                database.ref('orders/' + idToDelete).remove()
                    .then(() => {
                        showNotification('Order deleted successfully!');
                        orderModal.style.display = 'none';
                        loadDashboardData();
                        loadOrders();
                    })
                    .catch(error => {
                        showNotification('Error deleting order: ' + error.message, 'error');
                    });
            }
        }

        // Delete booking
        function deleteBooking(bookingId = null) {
            const idToDelete = bookingId || currentBookingId;
            if (!idToDelete) return;
            
            if (confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                database.ref('bookings/' + idToDelete).remove()
                    .then(() => {
                        showNotification('Booking deleted successfully!');
                        bookingModal.style.display = 'none';
                        loadDashboardData();
                        loadBookings();
                    })
                    .catch(error => {
                        showNotification('Error deleting booking: ' + error.message, 'error');
                    });
            }
        }

        // Delete product
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                database.ref('products/' + productId).remove()
                    .then(() => {
                        showNotification('Product deleted successfully!');
                        loadProducts();
                    })
                    .catch(error => {
                        showNotification('Error deleting product: ' + error.message, 'error');
                    });
            }
        }

        // Delete category
        function deleteCategory(categoryId) {
            if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                database.ref('categories/' + categoryId).remove()
                    .then(() => {
                        showNotification('Category deleted successfully!');
                        loadCategories();
                    })
                    .catch(error => {
                        showNotification('Error deleting category: ' + error.message, 'error');
                    });
            }
        }

        // Update order status
        function updateOrderStatus(orderId, newStatus) {
            database.ref('orders/' + orderId).update({
                status: newStatus
            })
            .then(() => {
                showNotification('Order status updated successfully!');
            })
            .catch(error => {
                showNotification('Error updating order status: ' + error.message, 'error');
            });
        }

        // Update booking status
        function updateBookingStatus(bookingId, newStatus) {
            database.ref('bookings/' + bookingId).update({
                status: newStatus
            })
            .then(() => {
                showNotification('Booking status updated successfully!');
            })
            .catch(error => {
                showNotification('Error updating booking status: ' + error.message, 'error');
            });
        }

        // Add product
        function addProduct(e) {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                original_price: parseFloat(document.getElementById('productOriginalPrice').value) || null,
                description: document.getElementById('productDescription').value,
                image: document.getElementById('productImage').value,
                ingredients: document.getElementById('productIngredients').value ? 
                    document.getElementById('productIngredients').value.split(',').map(i => i.trim()) : [],
                featured: document.getElementById('productFeatured').checked,
                createdAt: new Date().toISOString()
            };
            
            database.ref('products').push(product)
                .then(() => {
                    showNotification('Product added successfully!');
                    document.getElementById('addProductForm').reset();
                    loadProducts();
                })
                .catch(error => {
                    showNotification('Error adding product: ' + error.message, 'error');
                });
        }

        // Add category
        function addCategory(e) {
            e.preventDefault();
            
            const category = document.getElementById('categoryName').value;
            
            database.ref('categories').push(category)
                .then(() => {
                    showNotification('Category added successfully!');
                    document.getElementById('addCategoryForm').reset();
                    loadCategories();
                })
                .catch(error => {
                    showNotification('Error adding category: ' + error.message, 'error');
                });
        }

        // Load points rules
        function loadPointsRules() {
            if (!userAccess.includes('points')) return;
            
            database.ref('pointsRules').once('value').then(snapshot => {
                const rules = snapshot.val();
                const rewardsContainer = document.getElementById('rewardsContainer');
                rewardsContainer.innerHTML = '';
                
                if (rules && rules.rewards) {
                    rules.rewards.forEach((reward, index) => {
                        const rewardElement = document.createElement('div');
                        rewardElement.classList.add('form-row');
                        rewardElement.innerHTML = `
                            <div class="form-group">
                                <label>Reward Name</label>
                                <input type="text" value="${reward.name}" data-reward-index="${index}" data-reward-field="name" required>
                            </div>
                            <div class="form-group">
                                <label>Points Required</label>
                                <input type="number" value="${reward.points}" data-reward-index="${index}" data-reward-field="points" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" value="${reward.description}" data-reward-index="${index}" data-reward-field="description" required>
                            </div>
                            <div class="form-group">
                                <label>Max Value (MVR)</label>
                                <input type="number" value="${reward.maxValue}" data-reward-index="${index}" data-reward-field="maxValue" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Booking Type</label>
                                <input type="text" value="${reward.bookingType}" data-reward-index="${index}" data-reward-field="bookingType" placeholder="karaoke, small-party, etc.">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-danger remove-reward" data-reward-index="${index}">Remove</button>
                            </div>
                        `;
                        rewardsContainer.appendChild(rewardElement);
                    });
                }
                
                // Add event listener for adding new rewards
                document.getElementById('addRewardBtn').addEventListener('click', addNewReward);
                
                // Add event listeners for removing rewards
                document.querySelectorAll('.remove-reward').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = btn.dataset.rewardIndex;
                        removeReward(index);
                    });
                });
                
                // Set points per order if exists
                if (rules && rules.pointsPerOrder) {
                    document.getElementById('pointsPerOrder').value = rules.pointsPerOrder;
                }
            });
        }

        // Load customer points
        function loadCustomerPoints() {
            if (!userAccess.includes('points')) return;
            
            database.ref('customerPoints').once('value').then(snapshot => {
                const customers = snapshot.val();
                const customerPointsTable = document.getElementById('customerPointsTable').querySelector('tbody');
                const pointsTableFooter = document.getElementById('pointsTableFooter');
                customerPointsTable.innerHTML = '';
                pointsTableFooter.innerHTML = '';
                
                let totalPoints = 0;
                let customerCount = 0;
                
                if (customers) {
                    Object.entries(customers).forEach(([id, customer]) => {
                        const points = customer.points || 0;
                        totalPoints += points;
                        customerCount++;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.phone || 'N/A'}</td>
                            <td>${points}</td>
                            <td>${customer.firstOrder ? new Date(customer.firstOrder).toLocaleDateString() : 'N/A'}</td>
                            <td>${customer.lastOrder ? new Date(customer.lastOrder).toLocaleDateString() : 'N/A'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-secondary edit-points" data-id="${id}">Edit Points</button>
                                <button class="btn btn-danger delete-points" data-id="${id}">Delete</button>
                            </td>
                        `;
                        customerPointsTable.appendChild(row);
                    });
                    
                    // Add subtotal row
                    if (customerCount > 0) {
                        const footerRow = document.createElement('tr');
                        footerRow.style.fontWeight = 'bold';
                        footerRow.innerHTML = `
                            <td>Subtotal (${customerCount} customers)</td>
                            <td>${totalPoints}</td>
                            <td colspan="3"></td>
                        `;
                        pointsTableFooter.appendChild(footerRow);
                    }
                }
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.edit-points').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.dataset.id;
                        editCustomerPoints(customerId);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-points').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const customerId = btn.dataset.id;
                        deleteCustomerPoints(customerId);
                    });
                });
            });
        }

        // Load store settings
        function loadStoreSettings() {
            if (!userAccess.includes('settings')) return;
            
            database.ref('shippingSettings').once('value').then(snapshot => {
                const settings = snapshot.val();
                if (settings) {
                    document.getElementById('freeShippingThreshold').value = settings.freeShippingThreshold || 100;
                    document.getElementById('shippingCost').value = settings.shippingCost || 5.99;
                }
            });
            
            database.ref('catalogName').once('value').then(snapshot => {
                const name = snapshot.val();
                if (name) {
                    document.getElementById('storeName').value = name;
                }
            });
            
            database.ref('tablesCount').once('value').then(snapshot => {
                const count = snapshot.val();
                if (count) {
                    tablesCount = count;
                    document.getElementById('tablesCount').value = count;
                }
            });
        }

        // Save points rules
        function savePointsRules(e) {
            e.preventDefault();
            
            const pointsPerOrder = parseInt(document.getElementById('pointsPerOrder').value);
            const rewards = [];
            
            // Collect rewards data
            document.querySelectorAll('[data-reward-index]').forEach(input => {
                const index = input.dataset.rewardIndex;
                const field = input.dataset.rewardField;
                const value = input.value;
                
                if (!rewards[index]) {
                    rewards[index] = {};
                }
                
                rewards[index][field] = field === 'points' || field === 'maxValue' ? parseInt(value) : value;
            });
            
            const rules = {
                pointsPerOrder: pointsPerOrder,
                rewards: rewards.filter(r => r !== null)
            };
            
            database.ref('pointsRules').set(rules)
                .then(() => {
                    showNotification('Points rules saved successfully!');
                })
                .catch(error => {
                    showNotification('Error saving points rules: ' + error.message, 'error');
                });
        }

        // Save store settings
        function saveStoreSettings(e) {
            e.preventDefault();
            
            const shippingSettings = {
                freeShippingThreshold: parseFloat(document.getElementById('freeShippingThreshold').value),
                shippingCost: parseFloat(document.getElementById('shippingCost').value)
            };
            
            const catalogName = document.getElementById('storeName').value;
            tablesCount = parseInt(document.getElementById('tablesCount').value);
            
            database.ref('shippingSettings').set(shippingSettings)
                .then(() => {
                    return database.ref('catalogName').set(catalogName);
                })
                .then(() => {
                    return database.ref('tablesCount').set(tablesCount);
                })
                .then(() => {
                    showNotification('Store settings saved successfully!');
                    loadTables();
                })
                .catch(error => {
                    showNotification('Error saving store settings: ' + error.message, 'error');
                });
        }

        // Add new reward
        function addNewReward() {
            const rewardsContainer = document.getElementById('rewardsContainer');
            const index = document.querySelectorAll('[data-reward-index]').length / 5; // 5 fields per reward
            
            const rewardElement = document.createElement('div');
            rewardElement.classList.add('form-row');
            rewardElement.innerHTML = `
                <div class="form-group">
                    <label>Reward Name</label>
                    <input type="text" data-reward-index="${index}" data-reward-field="name" required>
                </div>
                <div class="form-group">
                    <label>Points Required</label>
                    <input type="number" data-reward-index="${index}" data-reward-field="points" min="1" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" data-reward-index="${index}" data-reward-field="description" required>
                </div>
                <div class="form-group">
                    <label>Max Value (MVR)</label>
                    <input type="number" data-reward-index="${index}" data-reward-field="maxValue" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Booking Type</label>
                    <input type="text" data-reward-index="${index}" data-reward-field="bookingType" placeholder="karaoke, small-party, etc.">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-danger remove-reward" data-reward-index="${index}">Remove</button>
                </div>
            `;
            rewardsContainer.appendChild(rewardElement);
            
            // Add event listener for removing this reward
            rewardElement.querySelector('.remove-reward').addEventListener('click', () => {
                removeReward(index);
            });
        }

        // Remove reward
        function removeReward(index) {
            document.querySelectorAll(`[data-reward-index="${index}"]`).forEach(element => {
                element.parentElement.parentElement.remove();
            });
        }

        // Edit customer points
        function editCustomerPoints(customerId) {
            const newPoints = prompt('Enter new points value:');
            if (newPoints !== null && !isNaN(newPoints)) {
                database.ref('customerPoints/' + customerId + '/points').set(parseInt(newPoints))
                    .then(() => {
                        showNotification('Customer points updated successfully!');
                        loadCustomerPoints();
                    })
                    .catch(error => {
                        showNotification('Error updating customer points: ' + error.message, 'error');
                    });
            }
        }

        // Delete customer points
        function deleteCustomerPoints(customerId) {
            if (confirm('Are you sure you want to delete this customer points record?')) {
                database.ref('customerPoints/' + customerId).remove()
                    .then(() => {
                        showNotification('Customer points record deleted successfully!');
                        loadCustomerPoints();
                    })
                    .catch(error => {
                        showNotification('Error deleting customer points record: ' + error.message, 'error');
                    });
            }
        }

        // Export to Excel
        function exportToExcel(type) {
            let data = [];
            let fileName = '';
            let subtotal = 0;
            let count = 0;
            
            switch(type) {
                case 'sales':
                    const salesData = getSalesData();
                    data = salesData.data;
                    subtotal = salesData.subtotal;
                    count = salesData.count;
                    fileName = 'sales_report.xlsx';
                    break;
                case 'orders':
                    const ordersData = getOrdersData();
                    data = ordersData.data;
                    subtotal = ordersData.subtotal;
                    count = ordersData.count;
                    fileName = 'orders_report.xlsx';
                    break;
                case 'bookings':
                    const bookingsData = getBookingsData();
                    data = bookingsData.data;
                    count = bookingsData.count;
                    fileName = 'bookings_report.xlsx';
                    break;
                case 'points':
                    const pointsData = getPointsData();
                    data = pointsData.data;
                    subtotal = pointsData.subtotal;
                    count = pointsData.count;
                    fileName = 'points_report.xlsx';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Add subtotal row
            if (type === 'sales' || type === 'orders') {
                data.push({});
                data.push({
                    'Date': `Subtotal (${count} ${type})`,
                    'Order #': '',
                    'Customer': '',
                    'Amount': `MVR ${subtotal.toFixed(2)}`,
                    'Status': ''
                });
            } else if (type === 'points') {
                data.push({});
                data.push({
                    'Phone': `Subtotal (${count} customers)`,
                    'Points': subtotal,
                    'First Order': '',
                    'Last Order': '',
                    'Actions': ''
                });
            } else if (type === 'bookings') {
                data.push({});
                data.push({
                    'Booking #': `Subtotal (${count} bookings)`,
                    'Customer': '',
                    'Phone': '',
                    'Date': '',
                    'Type': '',
                    'Status': '',
                    'Actions': ''
                });
            }
            
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Report');
            XLSX.writeFile(workbook, fileName);
            showNotification('Excel file exported successfully!');
        }

        // Export to PDF
        function exportToPdf(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let data = [];
            let headers = [];
            let title = '';
            let subtotal = 0;
            let count = 0;
            
            switch(type) {
                case 'sales':
                    const salesData = getSalesData();
                    data = salesData.data;
                    headers = ['Date', 'Order #', 'Customer', 'Amount', 'Status'];
                    subtotal = salesData.subtotal;
                    count = salesData.count;
                    title = 'Sales Report';
                    break;
                case 'orders':
                    const ordersData = getOrdersData();
                    data = ordersData.data;
                    headers = ['Order #', 'Customer', 'Date', 'Amount', 'Payment Method', 'Status'];
                    subtotal = ordersData.subtotal;
                    count = ordersData.count;
                    title = 'Orders Report';
                    break;
                case 'bookings':
                    const bookingsData = getBookingsData();
                    data = bookingsData.data;
                    headers = ['Booking #', 'Customer', 'Phone', 'Date', 'Type', 'Status'];
                    count = bookingsData.count;
                    title = 'Bookings Report';
                    break;
                case 'points':
                    const pointsData = getPointsData();
                    data = pointsData.data;
                    headers = ['Phone', 'Points', 'First Order', 'Last Order'];
                    subtotal = pointsData.subtotal;
                    count = pointsData.count;
                    title = 'Points Report';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Add title
            doc.setFontSize(16);
            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);
            
            // Prepare table data
            const tableData = data.map(row => {
                return headers.map(header => row[header] || '');
            });
            
            // Add table
            doc.autoTable({
                startY: 25,
                head: [headers],
                body: tableData
            });
            
            // Add subtotal
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            
            if (type === 'sales' || type === 'orders') {
                doc.text(`Subtotal (${count} ${type}): MVR ${subtotal.toFixed(2)}`, 14, finalY);
            } else if (type === 'points') {
                doc.text(`Subtotal (${count} customers): ${subtotal} points`, 14, finalY);
            } else if (type === 'bookings') {
                doc.text(`Subtotal (${count} bookings)`, 14, finalY);
            }
            
            // Save the PDF
            doc.save(`${title.toLowerCase().replace(/\s/g, '_')}.pdf`);
            showNotification('PDF file exported successfully!');
        }

        // Get sales data for export
        function getSalesData() {
            const salesTable = document.getElementById('salesTable');
            const data = [];
            let subtotal = 0;
            let count = 0;
            
            // Get table rows
            salesTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Date': cells[0].textContent.trim(),
                    'Order #': cells[1].textContent.trim(),
                    'Customer': cells[2].textContent.trim(),
                    'Amount': cells[3].textContent.trim(),
                    'Status': cells[4].textContent.trim()
                };
                
                // Extract numeric value from amount
                const amountValue = parseFloat(cells[3].textContent.replace('MVR', '').trim());
                if (!isNaN(amountValue)) {
                    subtotal += amountValue;
                    count++;
                }
                
                data.push(rowData);
            });
            
            return { data, subtotal, count };
        }

        // Get orders data for export
        function getOrdersData() {
            const ordersTable = document.getElementById('ordersTable');
            const data = [];
            let subtotal = 0;
            let count = 0;
            
            // Get table rows
            ordersTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Order #': cells[0].textContent.trim(),
                    'Customer': cells[1].textContent.trim(),
                    'Date': cells[2].textContent.trim(),
                    'Amount': cells[3].textContent.trim(),
                    'Payment Method': cells[4].textContent.trim(),
                    'Status': cells[5].textContent.trim()
                };
                
                // Extract numeric value from amount
                const amountValue = parseFloat(cells[3].textContent.replace('MVR', '').trim());
                if (!isNaN(amountValue)) {
                    subtotal += amountValue;
                    count++;
                }
                
                data.push(rowData);
            });
            
            return { data, subtotal, count };
        }

        // Get bookings data for export
        function getBookingsData() {
            const bookingsTable = document.getElementById('bookingsTable');
            const data = [];
            let count = 0;
            
            // Get table rows
            bookingsTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Booking #': cells[0].textContent.trim(),
                    'Customer': cells[1].textContent.trim(),
                    'Phone': cells[2].textContent.trim(),
                    'Date': cells[3].textContent.trim(),
                    'Type': cells[4].textContent.trim(),
                    'Status': cells[5].textContent.trim()
                };
                
                count++;
                data.push(rowData);
            });
            
            return { data, count };
        }

        // Get points data for export
        function getPointsData() {
            const pointsTable = document.getElementById('customerPointsTable');
            const data = [];
            let subtotal = 0;
            let count = 0;
            
            // Get table rows
            pointsTable.querySelectorAll('tbody tr').forEach(row => {
                const cells = row.cells;
                const rowData = {
                    'Phone': cells[0].textContent.trim(),
                    'Points': cells[1].textContent.trim(),
                    'First Order': cells[2].textContent.trim(),
                    'Last Order': cells[3].textContent.trim()
                };
                
                // Extract points value
                const pointsValue = parseInt(cells[1].textContent.trim());
                if (!isNaN(pointsValue)) {
                    subtotal += pointsValue;
                    count++;
                }
                
                data.push(rowData);
            });
            
            return { data, subtotal, count };
        }

        // Initialize the admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', initAdmin);
    </script>
</body>
</html>